name: Submit to CRAN

on:
  create:
    tags:
      - v*

jobs:
  getTagName:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.getTag.outputs.tag }}
    steps:
      - name: Get tag name
        id: getTag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

  submitToCran:
    runs-on: ubuntu-latest
    needs: getTagName
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          # Checkout to the tag that was used for the release
          ref: ${{ needs.getTagName.outputs.tag }}

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::curl, any::httr

      - name: Get release asset URL
        id: getReleaseUrl
        run: |
          TAG="${{ needs.getTagName.outputs.tag }}"
          REPO="${{ github.repository }}"

          ASSET_INFO=$(curl -s "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")
              
          echo "$ASSET_INFO" | jq -r '.assets[] | "\(.name)=\(.browser_download_url)"' > assets.txt

          cat assets.txt

          echo "ASSET_LIST=$(cat assets.txt | jq -Rs .)" >> "$GITHUB_OUTPUT"

      - name: Download all release assets
        run: |
          while IFS='=' read -r name url; do
            echo "Downloading $name"
            curl -L -o "$name" "$url"
          done < assets.txt

      - name: Submit to CRAN using devtools
        run: |
          cli::cli_inform("Using devtools for submission. Rebuilding the package...")

          # Override the 'devtools::yesno' function to always behave as if "yes" was selected
          unlockBinding("yesno", asNamespace("devtools"))
          assign("yesno", function(...) FALSE, envir = asNamespace("devtools"))
          lockBinding("yesno", asNamespace("devtools"))

          # Rebuild the package and submit to CRAN
          devtools::build_vignettes()
          devtools::document()
          devtools::submit_cran()
        shell: Rscript {0}
